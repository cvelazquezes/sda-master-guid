# Continuous Integration Workflow
# Runs tests, linting, and type checking on every push and PR

name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run ESLint
        run: npm run lint
      
      - name: Check formatting
        run: npm run format:check
      
      - name: Type check
        run: npm run type-check

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests with coverage
        run: npm run test:coverage
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/coverage-final.json
          fail_ci_if_error: true
          verbose: true

  security:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true
      
      - name: Check for vulnerabilities
        run: |
          npm audit --json | jq '.vulnerabilities | 
          to_entries | 
          map(select(.value.severity == "high" or .value.severity == "critical")) | 
          length' > vuln_count.txt
          VULN_COUNT=$(cat vuln_count.txt)
          if [ "$VULN_COUNT" -gt "0" ]; then
            echo "Found $VULN_COUNT high/critical vulnerabilities"
            exit 1
          fi

  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [lint, test]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run all validations
        run: npm run validate
      
      - name: Build for bundle size check
        run: npm run build
      
      - name: Check bundle size
        run: |
          echo "üì¶ Checking bundle size..."
          
          # Get bundle sizes
          if [ -d "dist" ] || [ -d "build" ]; then
            BUILD_DIR="dist"
            [ -d "build" ] && BUILD_DIR="build"
            
            TOTAL_SIZE=$(du -sb $BUILD_DIR | cut -f1)
            TOTAL_SIZE_MB=$(echo "scale=2; $TOTAL_SIZE / 1024 / 1024" | bc)
            BUDGET_MB=5
            
            echo "Total bundle size: ${TOTAL_SIZE_MB}MB"
            echo "Budget: ${BUDGET_MB}MB"
            
            # Check if size exceeds budget
            if (( $(echo "$TOTAL_SIZE_MB > $BUDGET_MB" | bc -l) )); then
              echo "‚ùå Bundle size ${TOTAL_SIZE_MB}MB exceeds budget of ${BUDGET_MB}MB"
              exit 1
            else
              echo "‚úÖ Bundle size within budget"
            fi
            
            # Find large files
            echo "\nüìä Largest files:"
            find $BUILD_DIR -type f -exec du -h {} + | sort -rh | head -10
          else
            echo "‚ö†Ô∏è Build directory not found, skipping bundle size check"
          fi
      
      - name: Success
        run: echo "‚úÖ All quality gates passed!"

